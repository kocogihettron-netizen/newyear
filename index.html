<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I LOVE YOU</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; cursor: pointer; font-family: sans-serif; }
        canvas { display: block; }
        #start-hint {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; font-size: 1.2rem; font-weight: bold; z-index: 1000;
            text-align: center; border: 2px solid #ff3385; padding: 15px 25px;
            border-radius: 30px; background: rgba(255, 51, 133, 0.4);
            box-shadow: 0 0 20px #ff3385; animation: blink 1.5s infinite;
        }
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 20; pointer-events: none;
        }
        #heart-text {
            color: #00f2ff; font-size: clamp(1.2rem, 6vw, 2.2rem);
            font-weight: 900; text-shadow: 0 0 15px #00f2ff, 0 0 30px #00f2ff;
            letter-spacing: 2px; opacity: 0; transition: 1.5s; text-align: center;
        }
        #click-hint {
            margin-top: 15px; color: #ff3385; font-size: 13px; font-weight: bold;
            opacity: 0; transition: 1s; letter-spacing: 2px; text-shadow: 0 0 5px #ff3385;
        }
        #click-hint.show { opacity: 0.8; animation: blink 1.5s infinite; }
        .pulse-text { animation: heartbeat 1.2s infinite ease-in-out; opacity: 1 !important; }
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.96); display: flex; justify-content: center;
            align-items: center; color: #fff; opacity: 0; visibility: hidden;
            transition: 2.5s; z-index: 100;
        }
        #overlay.active { opacity: 1; visibility: visible; }
        .typewriter { font-size: 1.05rem; line-height: 1.8; border-left: 3px solid #ff3385; padding: 20px; max-width: 85%; font-style: italic; color: #fff; }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        @keyframes blink { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; } }
    </style>
</head>
<body>

<div id="start-hint">CHẠM ĐỂ BẮT ĐẦU</div>
<audio id="bgMusic" loop><source src="nhac.mp3" type="audio/mpeg"></audio>

<canvas id="canvas"></canvas>
<div id="ui-layer">
    <div id="heart-text">...I LOVE YOU...</div>
    <div id="click-hint">CHẠM ĐỂ TIẾP TỤC</div>
</div>

<div id="overlay">
    <div class="typewriter"><span id="text"></span></div>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const music = document.getElementById('bgMusic');
const startHint = document.getElementById('start-hint');

let rockets = [], particles = [], heartPoints = [], phase = 'firing', timer = 0, globalAlpha = 1;
let isStarted = false;
let audioCtx;

function playExplosion() {
    if (!audioCtx) return;
    const duration = 1.2;
    const bufferSize = audioCtx.sampleRate * duration;
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
    const noise = audioCtx.createBufferSource();
    noise.buffer = buffer;
    const filter = audioCtx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.setValueAtTime(550 + Math.random() * 450, audioCtx.currentTime);
    filter.frequency.exponentialRampToValueAtTime(15, audioCtx.currentTime + duration);
    const gain = audioCtx.createGain();
    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
    noise.connect(filter);
    filter.connect(gain);
    gain.connect(audioCtx.destination);
    noise.start();
}

function initHeart() {
    heartPoints = [];
    const r = Math.min(window.innerWidth, window.innerHeight) * 0.032; 
    for (let t = 0; t < Math.PI * 2; t += 0.1) {
        const x = 16 * Math.pow(Math.sin(t), 3) * r;
        const y = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)) * r;
        heartPoints.push({ x, y });
    }
}

function resize() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    initHeart();
}
window.addEventListener('resize', resize);

class Rocket {
    constructor() {
        this.x = Math.random() * (canvas.width * 0.8) + (canvas.width * 0.1);
        this.y = canvas.height;
        this.targetY = Math.random() * (canvas.height * 0.45) + 50;
        this.speed = Math.random() * 2 + 7.5;
        this.color = `hsl(${Math.random() * 360}, 100%, 65%)`;
        this.exploded = false;
    }
    update() {
        this.y -= this.speed;
        if (this.y <= this.targetY) { 
            this.exploded = true; 
            playExplosion();
            explode(this.x, this.y, this.color); 
        }
    }
    draw() {
        ctx.fillStyle = this.color;
        ctx.fillRect(this.x, this.y, 2, 16);
    }
}

class Particle {
    constructor(x, y, color, target) {
        this.x = x; this.y = y; this.color = color; this.target = target;
        this.vx = (Math.random() - 0.5) * 16.5;
        this.vy = (Math.random() - 0.5) * 16.5;
        this.friction = 0.925;
        this.size = Math.random() * 2.5 + 1.2;
        this.reached = false;
    }
    update() {
        if (phase === 'firing') {
            this.x += this.vx; this.y += this.vy;
            this.vx *= this.friction; this.vy *= this.friction;
            this.vy += 0.085;
        } else {
            const scale = 1 + Math.sin(Date.now() / 200) * 0.08;
            const tx = canvas.width/2 + this.target.x * scale;
            const ty = canvas.height/2 + this.target.y * scale;
            this.x += (tx - this.x) * 0.075;
            this.y += (ty - this.y) * 0.075;
            if(Math.abs(tx - this.x) < 1 && Math.abs(ty - this.y) < 1) this.reached = true;
        }
    }
    draw() {
        if (!this.reached) {
            ctx.fillStyle = (phase === 'firing') ? this.color : '#ff3385';
            ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
        }
    }
}

function explode(x, y, color) {
    for (let i = 0; i < 45; i++) {
        const target = heartPoints[Math.floor(Math.random() * heartPoints.length)];
        particles.push(new Particle(x, y, color, target));
    }
}

function drawSolidHeart() {
    if (phase !== 'converging') return;
    ctx.save();
    ctx.globalAlpha = globalAlpha;
    ctx.strokeStyle = '#ff3385'; ctx.lineWidth = 3.5;
    ctx.lineJoin = 'round'; ctx.shadowBlur = 15; ctx.shadowColor = '#ff3385';
    ctx.beginPath();
    const scale = 1 + Math.sin(Date.now() / 200) * 0.08;
    heartPoints.forEach((p, i) => {
        const x = canvas.width/2 + p.x * scale;
        const y = canvas.height/2 + p.y * scale;
        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    });
    ctx.closePath(); ctx.stroke(); ctx.restore();
}

function animate() {
    ctx.fillStyle = 'rgba(0, 0, 0, 0.28)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    if (isStarted) {
        timer++;
        if (phase === 'firing') {
            if (timer % 11 === 0 && timer < 700) rockets.push(new Rocket());
            if (timer === 780) {
                phase = 'converging';
                document.getElementById('heart-text').classList.add('pulse-text');
                document.getElementById('click-hint').classList.add('show');
            }
        }
        rockets = rockets.filter(r => !r.exploded);
        rockets.forEach(r => { r.update(); r.draw(); });
        if (particles.length > 2800) particles.splice(0, 60);
        particles.forEach(p => { p.update(); p.draw(); });
        if (timer > 820) drawSolidHeart();
    }
    requestAnimationFrame(animate);
}

window.addEventListener('click', () => {
    if (!isStarted) {
        isStarted = true;
        startHint.style.display = 'none';
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        music.play().catch(() => {});
        return;
    }
    if (phase === 'converging') {
        globalAlpha = 0.35; 
        document.getElementById('ui-layer').style.opacity = '0';
        const overlay = document.getElementById('overlay');
        if(!overlay.classList.contains('active')) {
            overlay.classList.add('active');
            const msg = "Chúc mừng năm mới! Đêm nay thật đặc biệt, nhưng tớ chỉ thấy lòng mình trĩu nặng... Tớ thực sự hối hận vì đã giữ kín tình cảm này quá lâu, hối hận vì đã không đủ dũng cảm để nói ra sớm hơn. Giờ đây, khi nhận ra năm mới đến cũng là khi tớ sắp không thể nhìn thấy cậu mỗi ngày đến trường, lòng tớ lại hụt hẫng. Tớ sẽ nhớ lắm nụ cười của cậu , nhớ cả những lần tớ cố tình đi chậm lại chỉ để được nhìn thấy bóng lưng cậu từ xa.Tớ hối hận vì để nỗi sợ lấn át cả khát khao được bày tỏ. Đêm nay, khi pháo hoa tan dần, tớ cũng xin được thả trôi những tâm tư này theo gió. Chúc cậu ở nơi mới luôn hạnh phúc và tỏa sáng rực rỡ. Cảm ơn cậu vì đã là lý do để mỗi sáng tớ mong được đến lớp. Tạm biệt cậu, và tạm biệt cả tình yêu thầm kín tớ dành cho cậu bấy lâu nay...";
            let i = 0;
            function type() {
                if (i < msg.length) {
                    document.getElementById("text").innerHTML += msg.charAt(i);
                    i++; setTimeout(type, 75);
                }
            }
            setTimeout(type, 600);
        }
    }
});

resize(); animate();
</script>
</body>
</html>